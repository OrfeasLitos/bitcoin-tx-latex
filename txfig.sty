% Many thanks to Vesselin Velichkov for
% providing an example of a particular transaction

\ProvidesPackage{txfig}

% ------- constants - start -----------
\NewDocumentCommand{\inoutheight}{}{10}
\NewDocumentCommand{\txboxmargin}{}{7}
% -------- constants - end ------------

% "make calc work" magic
\ExplSyntaxOn
\cs_new_eq:NN \calc \fp_eval:n
\ExplSyntaxOff

% global set length magic
% https://tex.stackexchange.com/questions/406015/defining-macro-gsetlength-as-global-setlength-reliable?noredirect=1&lq=1
\makeatletter
\gdef\gsetlength#1#2{%
  \begingroup
    \setlength\skip@{#2}% Local assignment to a scratch register.
    \global#1=\skip@    % Global assignement to #1;
                        % \relax is not necessary because of the following \endgroup.
  \endgroup             % \skip@ is restored by end of group.
}
\makeatother

% ------ functions - start ------------
% ------ only affect inputs -----------
\NewDocumentCommand{\offsetFromLines}{m}
  {\calc{#1 * \baselineskip / 2} + \txboxmargin}

\NewDocumentCommand{\setToMaxLength}{mm}{
  \foreach \pair in {#2} {
    \foreach \blob in \pair {
      \foreach \line in \blob {
        \gsetlength{#1}{\maxof{#1}{\widthof{\line}}}
      }
    }
  }
}

\NewDocumentCommand{\addOne}{mm}{\FPadd{#1}{#1}{1}}

\NewDocumentCommand{\countLinesOfBlob}{mm}
  {\forcsvlist{\addOne{#1}}{#2}}

\NewDocumentCommand{\countLinesOfArrow}{mm}{
  \forcsvlist{\countLinesOfBlob{#1}}{#2}
  \FPadd{#1}{#1}{2}
}

\NewDocumentCommand{\countLines}{mm}
  {\forcsvlist{\countLinesOfArrow{#1}}{#2}}
% ------- functions - end -------------

% ------- draw nodes - start ----------
% put new positioned node
% #1: position
% #2: node name
% #3: text string
\NewDocumentCommand{\pstext}{mmm}{\rput(#1){\rnode{#2}{{#3}}}}

% Text within a frame of fixed size i.e.
% Size of the frame does not depend on the text
% (#1,#2): position of the frame
% (#3): height of rectangle given as offsets with respect to 0 e.g.
% (1.0,0.25) means \pspolygon(-1.0,-0.25)(1.0,-0.25)(1.0,0.25)(-1.0,0.25)
% #4: rectangle color
% #5: text node name
% #6: text string
\def\textpolygon(#1,#2)(#3,#4)(#5)(#6)(#7) {
  \rput(#1,#2){
    \pspolygon[fillstyle=solid,fillcolor=#5](-#3,-#4)(#3,-#4)(#3,#4)(-#3,#4)
    \pstext{0,0}{#6}{#7}
  }
}

\NewDocumentCommand{\drawInArrow}{}{
  \pstext{
    \calc{-\inHorOffset*2-\boxHorOffset}pt,
    \calc{\inVertOffset -
      (\count + \arrowcorrection) * \baselineskip}pt
  }{n_input_\arrindex_from}{$$}
  \pstext{
    -\boxHorOffset,
    \calc{\inVertOffset -
      (\count + \arrowcorrection) * \baselineskip}pt
  }{n_input_\arrindex_to}{$$}
  \ncline[nodesepA=0.0,nodesepB=0.0,arrowsize=4pt]{->}
    {n_input_\arrindex_from}{n_input_\arrindex_to}
}

\NewDocumentCommand{\drawInputs}{m}{
  \gdef\count{0.5}

  \foreach \arrow [count=\arrindex] in {#1} {
    \gdef\arrowcorrection{-2}
    \foreach \blob [count=\blobindex] in \arrow {
      \foreach \line [count=\lineindex] in \blob {
        \rput(
          \calc{-\inHorOffset - \boxHorOffset}pt,
          \calc{\inVertOffset - \count * \baselineskip}pt
        ){\line}
        \ifthenelse{\blobindex=2}{
          \FPsub{\aux}{\arrowcorrection}{1}
          \global\let\arrowcorrection\aux%
        }{}
        \FPadd{\aux}{\count}{1}
        \global\let\count\aux%
      }
      \FPadd{\aux}{\count}{1}
      \global\let\count\aux%
    }
    \drawInArrow
    \FPadd{\aux}{\count}{1}
    \global\let\count\aux%
  }
}

\NewDocumentCommand{\drawoutput}{mm}{
  \rput(\calc{\outHorOffset+\boxHorOffset}pt, \calc{\index - (0.5 * \outputsno) - \inoutheight/35}){#1} % TODO: smarter y coordinates?
  \rput(\calc{\outHorOffset+\boxHorOffset}pt, \calc{\index - (0.5 * \outputsno) - 3*\inoutheight/35}){#2}
  \pstext{\boxHorOffset, \calc{\index - (0.5 * \outputsno) - 2*\inoutheight/35}}{n_output_\index_from}{$$}
  \pstext{\calc{\outHorOffset*2+\boxHorOffset}pt, \calc{\index - (0.5 * \outputsno) - 2*\inoutheight/35}}{n_output_\index_to}{$$}
  \ncline[nodesepA=0.0,nodesepB=0.0,arrowsize=4pt]{->}
    {n_output_\index_from}{n_output_\index_to}
}
\NewDocumentCommand{\prepareoutput}{>{\SplitList{,}}m}{\drawoutput#1}
% -------- draw nodes - end -----------

% -------- API ------------
% #1: text inside box e.g. "tx name"
% #2: inputs
% #3: outputs
\def\drawtx(#1)(#2)(#3){
  \newlength{\inHorOffset}
  \setToMaxLength{\inHorOffset}{#2}

  \newlength{\outHorOffset}
  \setToMaxLength{\outHorOffset}{#3}

  \newlength{\boxHorOffset}
  \setlength{\boxHorOffset}{\widthof{#1} / 2 + \txboxmargin}

  \countLines{\inLines}{#2}
  \newlength{\inVertOffset}
  \setlength{\inVertOffset}{\offsetFromLines{\inLines}}

  \countLines{\outLines}{#3}
  \newlength{\outVertOffset}
  \setlength{\outVertOffset}{\offsetFromLines{\outLines}}

  \newlength{\boxVertOffset}
  \setlength{\boxVertOffset}{\maxof{\inVertOffset}{\outVertOffset}}

  \foreach \input [count=\outidx] in {#3} {
    \gdef\outputsno{\outidx} %TODO: remove
  }

  \rput(0,0,0){
    \pnode{tx}{
      % inputs
      \drawInputs{#2}
      % box
      \textpolygon(0.0,0.0)(\boxHorOffset,\boxVertOffset)(white)(n_box)({#1})
      % outputs
      \foreach \output [count=\index] in {#3} {
        \expandafter\prepareoutput\expandafter{\output}
      }
    }
  }
}
