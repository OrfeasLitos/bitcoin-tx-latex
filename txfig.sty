% Many thanks to Vesselin Velichkov for
% providing an example of a particular transaction

\ProvidesPackage{txfig}

% ------- constants - start -----------
\NewDocumentCommand{\inoutheight}{}{10}
\NewDocumentCommand{\txboxmargin}{}{7}
% -------- constants - end ------------

% -- "make calc work" magic - start ---
\ExplSyntaxOn
\cs_new_eq:NN \calc \fp_eval:n
\ExplSyntaxOff
% --- "make calc work" magic - end ----

% ------ functions - start ------------
% ------ only affect inputs -----------
\NewDocumentCommand{\maxlength}{mmmmm}{\setlength{#1}{
  {\maxof{\widthof{#2}}{\maxof{\widthof{#3}}{\maxof{\widthof{#4}}{\widthof{#5}}}}} / 2}}

\NewDocumentCommand{\setmaxlength}{m>{\SplitArgument{3}{,}}m}{\maxlength{#1}#2}
% ------- functions - end -------------

% ------- draw nodes - start ----------
% put new positioned node
% #1: position
% #2: node name
% #3: text string
\def\pstext(#1)(#2)(#3){
    \rput(#1){\rnode{#2}{{#3}}}
}

% Text within a frame of fixed size i.e.
% Size of the frame does not depend on the text
% (#1,#2): position of the frame
% (#3): height of rectangle given as offsets with respect to 0 e.g.
% (1.0,0.25) means \pspolygon(-1.0,-0.25)(1.0,-0.25)(1.0,0.25)(-1.0,0.25)
% #4: rectangle color
% #5: text node name
% #6: text string
\def\textpolygon(#1,#2)(#3,#4)(#5)(#6)(#7) {
  \rput(#1,#2){
    \pspolygon[fillstyle=solid,fillcolor=#5](-#3,-#4)(#3,-#4)(#3,#4)(-#3,#4)
    \pstext(0,0)(#6)(#7)
  }
}

\NewDocumentCommand{\drawinput}{mm}{
  \rput(\calc{-\txinoffset-\txboxhoffset}pt, \calc{\index - (0.5 * \inputsno) - \inoutheight/35}){#1}
  \rput(\calc{-\txinoffset-\txboxhoffset}pt, \calc{\index - (0.5 * \inputsno) - 3*\inoutheight/35}){#2}
  \pstext(\calc{-\txinoffset*2-\txboxhoffset}pt, \calc{\index - (0.5 * \inputsno) - 2*\inoutheight/35})(n_input_\index_from)($$)
  \pstext(-\txboxhoffset, \calc{\index - (0.5 * \inputsno) - 2*\inoutheight/35})(n_input_\index_to)($$)
  \ncline[nodesepA=0.0,nodesepB=0.0,arrowsize=4pt]{->}
    {n_input_\index_from}{n_input_\index_to}
}
\NewDocumentCommand{\prepareinput}{>{\SplitArgument{1}{,}}m}{\drawinput#1}

\NewDocumentCommand{\drawoutput}{mm}{
  \rput(\calc{\txoutoffset+\txboxhoffset}pt, \calc{\index - (0.5 * \outputsno) - \inoutheight/35}){#1} % TODO: smarter y coordinates?
  \rput(\calc{\txoutoffset+\txboxhoffset}pt, \calc{\index - (0.5 * \outputsno) - 3*\inoutheight/35}){#2}
  \pstext(\txboxhoffset, \calc{\index - (0.5 * \outputsno) - 2*\inoutheight/35})(n_output_\index_from)($$)
  \pstext(\calc{\txoutoffset*2+\txboxhoffset}pt, \calc{\index - (0.5 * \outputsno) - 2*\inoutheight/35})(n_output_\index_to)($$)
  \ncline[nodesepA=0.0,nodesepB=0.0,arrowsize=4pt]{->}
    {n_output_\index_from}{n_output_\index_to}
}
\NewDocumentCommand{\prepareoutput}{>{\SplitArgument{1}{,}}m}{\drawoutput#1}
% -------- draw nodes - end -----------

% -------- API ------------
% #1: text inside box e.g. "tx name"
% #2: inputs
% #3: outputs
\def\btc(#1)(#2)(#3){
  \newlength{\txinoffset}
  \setmaxlength{\txinoffset}{#2}

  \newlength{\txoutoffset}
  \setmaxlength{\txoutoffset}{#3}

  \newlength{\txboxhoffset}
  \setlength{\txboxhoffset}{\widthof{#1} / 2 + \txboxmargin}

  \newlength{\maxinouts}
  \foreach \input [count=\inidx] in {#2} {
    \gdef\inputsno{\inidx}
  }
  \foreach \input [count=\outidx] in {#3} {
    \gdef\outputsno{\outidx}
  }
  \setlength{\maxinouts}{\maxof{\inputsno}{\outputsno}}

  \newlength{\txboxvoffset}
  \setlength{\txboxvoffset}{\calc{\maxinouts * \inoutheight} + \calc{3 * \txboxmargin}}

  \rput(0,0,0){
    \pnode{tx}{
      % inputs
      \foreach \input [count=\index] in {#2} {
        \expandafter\prepareinput\expandafter{\input}
      }
      % box
      \textpolygon(0.0,0.0)(\txboxhoffset,\txboxvoffset)(white)(n_box)({#1})
      % outputs
      \foreach \output [count=\index] in {#3} {
        \expandafter\prepareoutput\expandafter{\output}
      }
    }
  }
}
